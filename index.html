<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auth Code Generator</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #000;
    color: #fff;
    margin: 0;
    padding: 0;
}
.container {
    max-width: 700px;
    margin: auto;
    padding: 20px;
}
h1 {
    text-align:center;
    margin-bottom: 20px;
}
.card {
    background: #111;
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(255,255,255,0.1);
}
label {
    display: flex;
    align-items: center;
    margin-top: 10px;
    gap: 5px;
}
input[type=text], select, textarea {
    width: 100%;
    padding: 8px;
    margin-top:5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #333;
    color: #fff;
}
.checkbox-group, .radio-group {
    display:flex;
    flex-direction: column;
    gap: 5px;
    margin-top:5px;
}
input[type=checkbox] {
    accent-color: red;
}
button {
    padding: 10px 15px;
    border:none;
    border-radius: 8px;
    background:#007BFF;
    color:#fff;
    font-size:16px;
    cursor:pointer;
    margin-top:10px;
    width: 100%;
}
#qr-reader { width:100%; margin-top:10px; }
.code-item {
    background:#222;
    border-radius:8px;
    padding:10px;
    margin-bottom:8px;
    display:flex;
    flex-direction: column;
}
.code-qr { font-family: monospace; font-size:12px; color:#0f0; word-break:break-all;}
.version-footer {
    text-align:center; font-size:12px; color:#aaa; margin-top:15px;
}
</style>
</head>
<body>
<div class="container">
    <h1>Auth Code Generator</h1>

    <div class="card">
        <label>Serijski broj:</label>
        <input type="text" id="serialNumber">

        <label>Vrsta koda:</label>
        <div class="radio-group">
            <label><input type="radio" name="codeType" value="Hybrid"> Hybrid</label>
            <label><input type="radio" name="codeType" value="Regular"> Regular</label>
        </div>

        <label>Namjena:</label>
        <div class="checkbox-group">
            <label><input type="checkbox" name="purpose" value="Conversion"> Conversion</label>
            <label><input type="checkbox" name="purpose" value="Card replacement"> Card replacement</label>
            <label><input type="checkbox" name="purpose" value="Exciter replacement"> Exciter replacement</label>
            <label><input type="checkbox" name="purpose" value="New installation"> New installation</label>
            <label><input type="checkbox" name="purpose" value="RAM clear"> RAM clear</label>
            <label><input type="checkbox" name="purpose" value="Renewal"> Renewal</label>
        </div>

        <div id="specialFields"></div>

        <label>QR kod:</label>
        <button id="scanQR">Scan QR</button>
        <div id="qr-reader" style="display:none;"></div>

        <label>Manual QR / paste code:</label>
        <textarea id="manualQR" placeholder="Paste QR code here..." rows="2"></textarea>
    </div>

    <h3>Lista unosa:</h3>
    <div id="codeList"></div>

    <h3>Generirana poruka:</h3>
    <textarea id="messageBox" readonly style="height:200px;">Hello dear,

I need auth code for machine

</textarea>

<div class="version-footer">Version 1.1.25 | Created by M. Orgulan</div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
let messageBox = document.getElementById('messageBox');
let serialInput = document.getElementById('serialNumber');
let codeList = document.getElementById('codeList');
let scanQRBtn = document.getElementById('scanQR');
let qrReaderDiv = document.getElementById('qr-reader');
let manualQR = document.getElementById('manualQR');
let specialFieldsDiv = document.getElementById('specialFields');

let qrData = '';
let html5QrcodeScanner = null;
let codeEntries = [];

function extractCode(url){
    let match = url.match(/code=([A-Fa-f0-9]{40})/);
    return match ? match[1] : url;
}

function updateSpecialFields(){
    specialFieldsDiv.innerHTML = '';
    const selectedPurposes = Array.from(document.querySelectorAll('input[name="purpose"]:checked')).map(c=>c.value);
    selectedPurposes.forEach(p => {
        if(p === "Conversion" || p === "Card replacement"){
            let oldV = document.createElement('input');
            oldV.type = 'text';
            oldV.placeholder = 'Old version';
            oldV.className = 'oldVersion';
            let newV = document.createElement('input');
            newV.type = 'text';
            newV.placeholder = 'New version';
            newV.className = 'newVersion';
            specialFieldsDiv.appendChild(oldV);
            specialFieldsDiv.appendChild(newV);
        }
        if(p === "Exciter replacement"){
            let oldEx = document.createElement('input');
            oldEx.type = 'text';
            oldEx.placeholder = 'Old Ex';
            oldEx.className = 'oldEx';
            let newEx = document.createElement('input');
            newEx.type = 'text';
            newEx.placeholder = 'New Ex';
            newEx.className = 'newEx';
            specialFieldsDiv.appendChild(oldEx);
            specialFieldsDiv.appendChild(newEx);
        }
    });
}

document.querySelectorAll('input[name="purpose"]').forEach(c => c.addEventListener('change', updateSpecialFields));

function addEntry(serial, codeType, purposes, qrData){
    let oldV = Array.from(document.getElementsByClassName('oldVersion')).map(i=>i.value).join(' / ');
    let newV = Array.from(document.getElementsByClassName('newVersion')).map(i=>i.value).join(' / ');
    let oldEx = Array.from(document.getElementsByClassName('oldEx')).map(i=>i.value).join(' / ');
    let newEx = Array.from(document.getElementsByClassName('newEx')).map(i=>i.value).join(' / ');

    let entry = {serial, codeType, purposes, qrData, oldV, newV, oldEx, newEx};
    codeEntries.push(entry);

    let div = document.createElement('div');
    div.className = 'code-item';
    div.innerHTML = `<strong>SN:</strong> ${serial} | <strong>${codeType}</strong> | <strong>Purpose:</strong> ${purposes}` +
                    (oldV||newV? `<br>Old: ${oldV} New: ${newV}`:'') +
                    (oldEx||newEx? `<br>Old Ex: ${oldEx} New Ex: ${newEx}`:'') +
                    `<div class="code-qr">${qrData}</div>`;
    codeList.appendChild(div);

    refreshMessageBox();
}

function refreshMessageBox(){
    messageBox.value = "Hello dear,\n\nI need auth code for machine\n\n";
    codeEntries.forEach(entry => {
        messageBox.value += `SN: ${entry.serial}\nCode type: ${entry.codeType}\nPurpose: ${entry.purposes}`;
        if(entry.oldV || entry.newV) messageBox.value += `\nOld: ${entry.oldV} New: ${entry.newV}`;
        if(entry.oldEx || entry.newEx) messageBox.value += `\nOld Ex: ${entry.oldEx} New Ex: ${entry.newEx}`;
        messageBox.value += `\nQR code: ${entry.qrData}\n\n`;
    });
}

// QR Scan
scanQRBtn.addEventListener('click', ()=>{
    qrReaderDiv.style.display='block';
    if(!html5QrcodeScanner) html5QrcodeScanner = new Html5Qrcode("qr-reader");
    html5QrcodeScanner.start(
        {facingMode:"environment"},
        {fps:10, qrbox:250},
        (decodedText)=>{
            qrData = extractCode(decodedText);
            let serial = serialInput.value.trim();
            let codeType = document.querySelector('input[name="codeType"]:checked')?.value || '';
            let purposes = Array.from(document.querySelectorAll('input[name="purpose"]:checked')).map(c=>c.value).join(' + ');
            addEntry(serial, codeType, purposes, qrData);
            new Audio('https://www.soundjay.com/buttons/sounds/beep-07.mp3').play();
            qrReaderDiv.style.display='none';
            html5QrcodeScanner.stop();
            serialInput.value='';
            document.querySelectorAll('input[name="codeType"]').forEach(r=>r.checked=false);
            document.querySelectorAll('input[name="purpose"]').forEach(c=>c.checked=false);
            specialFieldsDiv.innerHTML='';
        },
        (err)=>{}
    ).catch(console.error);
});

// Manual QR paste
manualQR.addEventListener('input', ()=>{
    let code = manualQR.value.trim();
    if(!code) return;
    qrData = extractCode(code);
    let serial = serialInput.value.trim();
    let codeType = document.querySelector('input[name="codeType"]:checked')?.value || '';
    let purposes = Array.from(document.querySelectorAll('input[name="purpose"]:checked')).map(c=>c.value).join(' + ');
    addEntry(serial, codeType, purposes, qrData);
    new Audio('https://www.soundjay.com/buttons/sounds/beep-07.mp3').play();
    manualQR.value='';
    serialInput.value='';
    document.querySelectorAll('input[name="codeType"]').forEach(r=>r.checked=false);
    document.querySelectorAll('input[name="purpose"]').forEach(c=>c.checked=false);
    specialFieldsDiv.innerHTML='';
});
</script>
</body>
</html>