<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auth Code Generator</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
body { font-family: Arial, sans-serif; background: #000; color:#fff; margin:0; padding:0;}
.container { max-width: 700px; margin: auto; padding: 20px; }
h1 { text-align:center; margin-bottom:10px;}
.card { background: #111; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(255,255,255,0.1);}
label { display: block; margin-top: 10px; }
input[type=text], select, textarea { width: 100%; padding: 8px; margin-top:5px; border-radius: 6px; border: 1px solid #555; background:#333; color:#fff; }
.checkbox-group, .radio-group { display:flex; gap: 10px; margin-top:5px; flex-wrap: wrap; align-items:center; }
.checkbox-group label, .radio-group label { display:flex; align-items:center; gap:5px; }
button { padding: 10px 15px; border:none; border-radius: 8px; background:#007BFF; color:#fff; font-size:16px; cursor:pointer; margin-top:10px; width:100%; }
button:disabled { background:#555; cursor:not-allowed;}
#qr-reader { width:100%; margin-top:10px; display:none; }
.created-by, .version-footer { text-align:center; font-size:12px; color:#aaa; }
.code-item { background:#222; border-radius:8px; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;}
.code-details { flex:1;}
.code-remove { cursor:pointer; color:red; font-weight:bold; margin-left:10px; }
.code-qr { font-family: monospace; font-size:12px; color:#0f0; margin-top:5px; word-break:break-all;}
.purpose-special { margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;}
input.success { border-color:#0f0; }

.contact-buttons { display:flex; gap:10px; flex-wrap:wrap; margin-top:15px; }
.contact-buttons a { flex:1; display:flex; align-items:center; justify-content:center; padding:10px; border-radius:8px; color:#fff; font-weight:bold; text-decoration:none; gap:5px; }
.contact-buttons .whatsapp-btn { background:#25D366; }
.contact-buttons .viber-btn { background:#665CAC; }
.btn-icon { width:20px; height:20px; }
</style>
</head>

<body>
<div class="container">
    <div class="created-by">Created by M.Orgulan</div>
    <h1>Auth Code Generator</h1>

<div class="card">
    <label>Serijski broj:</label>
    <input type="text" id="serialNumber">

    <label>Vrsta koda:</label>
    <div class="radio-group">
        <label><input type="radio" name="codeType" value="Hybrid"> Hybrid:</label>
        <label><input type="radio" name="codeType" value="Regular"> Regular:</label>
    </div>

    <label>Namjena:</label>
    <div class="checkbox-group">
        <label><input type="checkbox" name="purpose" value="Conversion"> Conversion:</label>
        <label><input type="checkbox" name="purpose" value="Card replacement"> Card replacement:</label>
        <label><input type="checkbox" name="purpose" value="Exciter replacement"> Exciter replacement:</label>
        <label><input type="checkbox" name="purpose" value="New installation"> New installation:</label>
        <label><input type="checkbox" name="purpose" value="RAM clear"> RAM clear:</label>
        <label><input type="checkbox" name="purpose" value="Renewal"> Renewal:</label>
    </div>

    <div id="specialFields" class="purpose-special"></div>

    <button id="scanQR">Scan QR Code</button>
    <div id="qr-reader"></div>

    <label>Manual QR / Paste code:</label>
    <textarea id="manualQR" placeholder="Paste QR URL or code here..." rows="2"></textarea>
</div>

<h3>Lista unosa:</h3>
<div id="codeList"></div>

<h3>Generirana poruka:</h3>
<textarea id="messageBox" readonly rows="10" style="background:#333;color:#0f0;"></textarea>
<button id="copyMessage">Copy Message</button>

<div class="contact-buttons">
    <a href="viber://chat?number=%2B359896710272" class="viber-btn">
        <img src="https://upload.wikimedia.org/wikipedia/commons/2/2d/Viber_logo_icon.svg" class="btn-icon"> Viber
    </a>
    <a href="https://wa.me/" class="whatsapp-btn">
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/3b/WhatsApp_icon.svg" class="btn-icon"> WhatsApp
    </a>
</div>

<div class="version-footer">Version 7.1.26</div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
let messageBox = document.getElementById('messageBox');
let serialInput = document.getElementById('serialNumber');
let codeList = document.getElementById('codeList');
let scanQRBtn = document.getElementById('scanQR');
let qrReaderDiv = document.getElementById('qr-reader');
let specialFieldsDiv = document.getElementById('specialFields');
let manualQR = document.getElementById('manualQR');

let html5QrcodeScanner = null;
let codeEntries = [];

function extractCode(url){
    let match = url.match(/code=([A-Fa-f0-9]{42})/);
    return match ? match[1] : url;
}

function updateSpecialFields(){
    specialFieldsDiv.innerHTML = '';
    const purposes = Array.from(document.querySelectorAll('input[name="purpose"]:checked')).map(c=>c.value);
    purposes.forEach(purpose=>{
        if(purpose==='Conversion' || purpose==='Card replacement'){
            specialFieldsDiv.innerHTML += `<input type="text" id="oldVersion" placeholder="Old version">
                                           <input type="text" id="newVersion" placeholder="New version">`;
        }
        if(purpose==='Exciter replacement'){
            specialFieldsDiv.innerHTML += `<input type="text" id="oldEx" placeholder="Old Ex">
                                           <input type="text" id="newEx" placeholder="New Ex">`;
        }
    });
}

document.querySelectorAll('input[name="purpose"]').forEach(c => c.addEventListener('change', updateSpecialFields));

function addEntry(serial, codeType, purposes, qr){
    let entry = {serial, codeType, purposes, qr};
    codeEntries.push(entry);

    let div = document.createElement('div');
    div.className='code-item';
    div.innerHTML = `<div class="code-details">
        <strong>SN:</strong> ${serial} | <strong>${codeType}</strong> | <strong>${purposes}</strong>
        <div class="code-qr">${qr}</div>
    </div>
    <span class="code-remove">X</span>`;

    div.querySelector('.code-remove').onclick=()=>{
        codeList.removeChild(div);
        codeEntries = codeEntries.filter(e=>e!==entry);
        refreshMessageBox();
    };

    codeList.appendChild(div);
    refreshMessageBox();
}

function refreshMessageBox(){
    messageBox.value = "Hello dear,\n\nI need auth codes for the following machines:\n\n";
    codeEntries.forEach(e=>{
        messageBox.value += `SN: ${e.serial}\nCode type: ${e.codeType}\nPurpose: ${e.purposes}\nQR: ${e.qr}\n\n`;
    });
}

scanQRBtn.addEventListener('click',()=>{
    qrReaderDiv.style.display='block';
    if(!html5QrcodeScanner) html5QrcodeScanner = new Html5Qrcode("qr-reader");
    html5QrcodeScanner.start({facingMode:"environment"},{fps:10,qrbox:250},
        decoded=>{
            let qr = extractCode(decoded);
            let serial = serialInput.value.trim();
            let codeType = document.querySelector('input[name="codeType"]:checked')?.value;
            let purposes = Array.from(document.querySelectorAll('input[name="purpose"]:checked')).map(c=>c.value).join(' + ');
            if(serial && codeType && purposes){
                addEntry(serial, codeType, purposes, qr);
                new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                html5QrcodeScanner.stop();
                qrReaderDiv.style.display='none';
            }
        }
    );
});

manualQR.addEventListener('input',()=>{
    let qr = extractCode(manualQR.value.trim());
    let serial = serialInput.value.trim();
    let codeType = document.querySelector('input[name="codeType"]:checked')?.value;
    let purposes = Array.from(document.querySelectorAll('input[name="purpose"]:checked')).map(c=>c.value).join(' + ');
    if(serial && codeType && purposes && qr){
        addEntry(serial, codeType, purposes, qr);
        new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
        manualQR.value='';
    }
});

document.getElementById('copyMessage').onclick=()=>{
    navigator.clipboard.writeText(messageBox.value);
    alert('Message copied');
};
</script>
</body>
</html>